{% extends "loggedin.html" %}

{% block header %}{% include "header.html" with title="SEO Landing Page Builder" %}{% endblock header %}

{% block load-first %}
  {{ block.super }}
  <style>
    body {
      font-size: 16px;
    }
    section {
      padding: 20px 30px;
    }
    section.website {
      background-color: #bfd;
    }
    section.page {
      background-color: #fdb;
    }
    section.images {
      background-color: #ffc;
    }
    select {
      font-size: 16px;
    }
    #content-sections-list {
      max-width: 500px;
      margin: auto;
    }
  </style>
{% endblock load-first %}

{% block content %}
  <section class="website">
    <span>Website: </span>
    {% if websites %}
      <select id="website-select">
        <option value="">Select a website...</option>
        {% for w in websites %}
          <option value="{{ w.domain }}">{{ w.display_name }}</option>
        {% endfor %}
      </select>
    {% else %}
      <span><b>{{ website.display_name }}</b> ({{website.domain}})</span>
      <span> <a href="/content/builder">Change</a></span>
    {% endif %}
  </section>
  {% if website %}
    <section class="page">
      <span>Page: </span>
      {% if not make_model %}
        <select id="year-select">
          <option value="">Select a year...</option>
          <option>2021</option>
          <option>2020</option>
          <option>2019</option>
          <option>2018</option>
          <option>2017</option>
          <option>2016</option>
          <option>2015</option>
          <option>2014</option>
          <option>2013</option>
          <option>2012</option>
          <option>2011</option>
          <option>2010</option>
        </select>
        <select id="make-select">
          <option value="">Select a make...</option>
          {% for m in makes %}
            <option value="{{ m.make_slug }}">{{ m.make }}</option>
          {% endfor %}
        </select>
        {% for m in makes %}
          <select id="{{ m.make_slug }}-model-select" class="model-select" style="display: none">
            <option value="">Select a model...</option>
            {% for model in m.models %}
              <option value="{{ model.model_slug }}">{{ model.model }}</option>
            {% endfor %}
          </select>
        {% endfor %}
      {% else %}
        <b>{{ year }} {{ make_model.make }} {{ make_model.model }}</b>
        <span> <a href=".">Change</a></span>
      {% endif %}
    </section>
  {% endif %}
  {% if make_model %}
    <section class="images row">
      <span>Images available for {{ year}} {{ make_model.make }} {{ make_model.model }}: <b id="nimages-span">---</b></span>
      <span><a href="/seolp-media">Add images</a></span>
    </section>
    <div class="section">
      <h3 class="centered">Table of Contents:</h3>
      <ul id="content-sections-list" class="reorder-list">
      </ul>
    </div>
    <div class="centered">
      <select id="section-select"></select>
      <button id="add-section-button">Add section</button>
    </div>
    <div class="centered">
      <input id="deluxe-group-checkbox" type="checkbox" /> Deluxe
    </div>
    <div class="section centered">
      <button id="randomize-button">Generate</button>
      <button id="generate-button">Preview</button>
      <button id="raw-button">Show Text</button>
    </div>
  {% endif %}
  <section>
    <hr/>
    <p><small>
      Note: Before you can generate content for specific SEO landing pages here, you
      must first define the general page sections in the 
      <a href="/seolp-catalog">content catalog</a>.
    </small></p>
  </section>
{% endblock content %}

{% block load-last %}
  {{ block.super }}
  <script type="text/javascript">
    var contentIndex;
    var contentConfiguration;
    var currentImages;

    $("#website-select").on("change", function() {
      var domain = $(this).find("option:selected").val();
      if (domain) {
        window.location.href = "/content/builder/" + domain;
      }
    })

    $("#year-select").on("change", checkComplete);
    $(".model-select").on("change", checkComplete);
    $("#make-select").on("change", function() {
      $(".model-select").hide();
      if (makeValue()) {
        $("#" + makeValue() + "-model-select").show();
      }
      checkComplete();
    });

    $("#content-sections-list").sortable({
      start: function(event, ui) {
        var startingPos = ui.item.index();
        ui.item.data("startingPos", startingPos);
      },
      update: function(event, ui) {
        var startingPos = ui.item.data("startingPos")
        var endingPos = ui.item.index();
        var css = contentConfiguration.config.sections;
        var mover = css[startingPos];
        css.splice(startingPos, 1)
        css.splice(endingPos, 0, mover)
      }
    });
    $("#content-sections-list").disableSelection();

    function checkComplete() {
      if (websiteValue() && yearValue() && makeValue() && modelValue()) {
        window.location.href = "/content/builder/" + websiteValue() + "/" + getSlug();
      }
    }

    {% if make_model %}
      loadContentIndex().then(function(data) {
        contentIndex = data;
        loadContentConfiguration().then(function() {
          loadImages().then(function() {
            $(".require-selection button").attr("disabled", false);
            $(".require-selection input").attr("disabled", false);
            $(".require-selection").addClass("selection");
            $("#generate-button").text("Preview " + previewUrl());
            $("#generate-button").attr("disabled", false);
          })
        })
      })
    {% endif %}

    function loadContentConfiguration() {
      return ajaxGet("/api/1.0/ccfg/" + getContentKey())
      .then(function(data) {
        contentConfiguration = data;
        renderSections();
      })
      .catch(function(err) {
        if (err.status == 404) {
          contentConfiguration = { key: getContentKey(), config: { sections: [] }};
          for (var i = 0; i < contentIndex.allSections.length; ++i) {
            var section = contentIndex.allSections[i];
            if (!section.group) {
              addSectionToConfiguration(section);
            }
          }
          renderSections();
        }
        else {
          alert(err);
        }
      })
    }

    function renderSections() {
      $("#content-sections-list").empty();
      if (contentConfiguration && contentConfiguration.config.sections) {
        var sections = contentConfiguration.config.sections;
        var anyDeluxe = false;
        for (var i = 0; i < sections.length; ++i) {
          var section = sections[i];
          var row = renderSection(section.sid);
          $("#content-sections-list").append(row);
          anyDeluxe = anyDeluxe || contentIndex.byId[section.sid].group === "deluxe";
        }
      }
      renderSectionSelect();
      $("#deluxe-group-checkbox").prop("checked", anyDeluxe);
    }
    function sectionDisplayName(section) {
      return section.name + (section.group === "deluxe" ? " \u2606": "");
    }
    function renderSection(sid) {
      var row = $("<li>");
      row.append($('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><title>draggable</title><path d="M2 11h16v2H2zm0-4h16v2H2zm8 11l3-3H7l3 3zm0-16L7 5h6l-3-3z"/></svg>'))
      row.append($("<div>").text(sectionDisplayName(contentIndex.byId[sid])));
      var deleteButton = $("<button>Ã—</button>");
      row.append(deleteButton);
      deleteButton.on("click", function() {
        removeSection(sid);
      })
      $("#content-sections-list").append(row);
      return row;
    }

    function removeSection(sid) {
      if (contentConfiguration && contentConfiguration.config.sections) {
        var sections = contentConfiguration.config.sections;
        for (var i = 0; i < sections.length; ++i) {
          if (sections[i].sid == sid) {
            sections.splice(i, 1);
            renderSections();
            break;
          }
        }
      }
    }

    $("#add-section-button").on("click", function() {
      var option = $("#section-select").find("option:selected");
      if (option.val()) {
        var sectionId = option.val();
        addSectionToConfiguration(contentIndex.byId[sectionId]);
        renderSections();
      }
    })

    $("#deluxe-group-checkbox").on("click", function() {
      if (this.checked) {
        for (var i = 0; i < contentIndex.allSections.length; ++i) {
          var section = contentIndex.allSections[i];
          if (section.group === "deluxe") {
            if (!contentConfiguration.config.sections.find(function(s) {
              return s.sid === section.id;
            })) {
              addSectionToConfiguration(section);
            }
          }
        }
      }
      else {
        contentConfiguration.config.sections =
            contentConfiguration.config.sections.filter(function(s) {
              return contentIndex.byId[s.sid].group !== "deluxe";
            });
      }
      renderSections();
    })

    function addSectionToConfiguration(section) {
      var sectionId = section.id;
      var sectionName = section.name;
      contentConfiguration.config.sections.push({ sid: sectionId, name: sectionName });
    }

    function renderSectionSelect() {
      var $select = $("#section-select");
      $select.empty();
      if (contentConfiguration && contentConfiguration.config.sections) {
        var availableSections = contentIndex.allSections.filter(function(cs) {
          return !cs.group && !contentConfiguration.config.sections.find(function(ccs) { return ccs.sid == cs.id; })
        });
        if (!availableSections.length) {
          $select.append($("<option value=''>-- No available sections --</option>"));
        }
        else {
          $select.append($("<option value=''>Select a section to add</option>"));
        }
        for (var i = 0; i < availableSections.length; ++i) {
          var cs = availableSections[i];
          $select.append($("<option>").text(sectionDisplayName(cs)).attr("value", cs.id));
        }
      }
    }

    function loadImages() {
      return ajaxGet("/api/1.0/media", {
        year: yearValue(),
        make: makeValue(),
        model: modelValue()
      })
      .then(function(data) {
        currentImages = data;
        if (!data || !data.length) {
          $("#nimages-span").text("None")
        }
        else {
          $("#nimages-span").text("" + data.length)
        }
      })
      .catch(function(err) {
        alert(err);
      })
    }

    $("#randomize-button").on("click", function() {
      bindAllSectionVariants(true);
      saveContentConfiguration().then(function() {
        alert("Content randomized.")
      });
    });

    $("#raw-button").on("click", function() {
      bindAllSectionVariants(false);
      saveContentConfiguration().then(function() {
        var url = "/content/raw?website=" + websiteValue() + "&slug=" + getSlug()
        window.open(url, "_blank");
      });
    });

    $("#generate-button").on("click", function() {
      bindAllSectionVariants(false);
      saveContentConfiguration().then(function() {
        var url = "/content/preview?website=" + websiteValue() + "&slug=" + getSlug()
        window.open(url, "_blank");
      });
    });

    function bindAllSectionVariants(forceAll) {
      var config = contentConfiguration.config;
      var sections = config.sections;
      for (var i = 0; i < sections.length; ++i) {
        var section = sections[i];
        if (forceAll || !section.vid) {
          section.vid = chooseVariant(section.sid);
        }
      }
      if (forceAll || !config.image) {
        config.image = chooseImage();
      }
    }

    function pickRandom(array) {
      if (array.length) {
        return array[Math.floor(Math.random() * array.length)];
      }
    }

    function chooseVariant(sectionId) {
      var variants = contentIndex.byId[sectionId].variants;
      var variant = pickRandom(variants);
      return variant && variant.id;
    }

    function chooseImage() {
      if (currentImages && currentImages.length) {
        return pickRandom(currentImages)
        var n = currentImages.length;
        var index = Math.floor(Math.random() * n);
        return currentImages[index];
      }
      return null;
    }

    function saveContentConfiguration() {
      return ajaxPost("/api/1.0/ccfg", contentConfiguration)
    }

    function websiteValue() {
      return "{{ website.domain|escapejs }}";
    }
    function yearValue() {
      {% if year %}
        return {{ year }};
      {% else %}
        return $("#year-select option:selected").val()
      {% endif %}
    }
    function makeValue() {
      {% if make_model %}
        return "{{ make_model.make_slug|escapejs }}";
      {% else %}
        return $("#make-select option:selected").val()
      {% endif %}
    }
    function modelValue() {
      {% if make_model %}
        return "{{ make_model.model_slug|escapejs }}";
      {% else %}
        var make = makeValue();
        return make && $("#" + make + "-model-select option:selected").val();
      {% endif %}
    }
    function forSlug(value) {
      return value.replace(/[\s-]/g, "").toLowerCase();
    }
    function previewUrl() {
      return "https://" + websiteValue() + "/v-" + getSlug();
    }
    function getContentKey() {
      return websiteValue() + "-" + getSlug();
    }
    function getSlug() {
      return yearValue() + "-" + makeValue() + "-" + modelValue();
    }
  </script>
{% endblock load-last %}
